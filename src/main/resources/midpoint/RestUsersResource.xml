<?xml version="1.0" encoding="UTF-8"?>
<resource oid="2f7e91c8-1a85-4f5f-b0a9-1e2c3d4b5a60" xmlns="http://midpoint.evolveum.com/xml/ns/public/common/common-3"
		  xmlns:c="http://midpoint.evolveum.com/xml/ns/public/common/common-3"
		  xmlns:icfs="http://midpoint.evolveum.com/xml/ns/public/connector/icf-1/resource-schema-3"
		  xmlns:ri="http://midpoint.evolveum.com/xml/ns/public/resource/instance-3"
		  xmlns:xsd="http://www.w3.org/2001/XMLSchema"
		  xmlns:icfc="http://midpoint.evolveum.com/xml/ns/public/connector/icf-1/connector-schema-3"
		  xmlns:cfg="http://midpoint.evolveum.com/xml/ns/public/connector/icf-1/bundle/com.identicum.midpoint.rest-users-connector/com.identicum.connectors.RestUsersConnector"
		  xmlns:q="http://prism.evolveum.com/xml/ns/public/query-3"
		  xmlns:t="http://prism.evolveum.com/xml/ns/public/types-3"
		  xmlns:cap="http://midpoint.evolveum.com/xml/ns/public/resource/capabilities-3">

	<name>Koha REST Connector</name>

	<connectorRef type="ConnectorType">
		<filter>
			<q:and>
				<q:equal>
					<q:path>c:connectorType</q:path>
					<q:value>com.identicum.connectors.KohaConnector</q:value>
				</q:equal>
				<q:equal>
					<q:path>c:connectorVersion</q:path>
					<q:value>0.0.2-SNAPSHOT</q:value>
				</q:equal>
			</q:and>
		</filter>
	</connectorRef>

	<connectorConfiguration>
		<icfc:configurationProperties>
			<!--
                IMPORTANTE: serviceAddress debe ser la URL base de tu servidor Koha.
                Ej: http://koha.example.com o http://192.168.15.135:8080 (si Koha no corre en el puerto 80).
                NO incluyas /api/v1 aquí si tu conector Java (API_BASE_PATH) ya lo añade.
                Si tus logs de Koha muestran /api/v1/app.pl/api/v1/..., entonces serviceAddress
                probablemente debería ser http://192.168.15.135:8000 (o el puerto correcto de Koha)
                y API_BASE_PATH en el conector debería ser "/api/v1/app.pl" o ajustar esto aquí.
                Para el log que mostraste "GET /api/v1/app.pl/api/v1/patrons",
                si serviceAddress es "http://192.168.15.135:8000" y API_BASE_PATH es "/api/v1",
                la URL construida sería "http://192.168.15.135:8000/api/v1/patrons".
                El "/app.pl/" extra en tu log de Koha es peculiar. Verifica tu configuración de Koha (Apache/Nginx proxy).
                Por ahora, se asume que la URL base correcta para que el conector forme la URL de API es la siguiente:
            -->
			<cfg:serviceAddress>http://192.168.15.135:8000</cfg:serviceAddress>

			<cfg:authMethod>BASIC</cfg:authMethod>
			<cfg:username>koha_api_user</cfg:username> <cfg:password>
			<t:clearValue>koha_api_password</t:clearValue> </cfg:password>

			<!--
            <cfg:authMethod>OAUTH2_KOHA_CLIENT_CREDENTIALS</cfg:authMethod>
            <cfg:clientId>TU_CLIENT_ID_DE_KOHA</cfg:clientId>
            <cfg:clientSecret>
                <t:clearValue>TU_CLIENT_SECRET_DE_KOHA</t:clearValue>
            </cfg:clientSecret>
            <cfg:tokenUrlSuffix>/api/v1/oauth/token</cfg:tokenUrlSuffix> <!- Este es el valor por defecto en KohaConfiguration.java ->
            -->

			<cfg:trustAllCertificates>true</cfg:trustAllCertificates> </icfc:configurationProperties>
	</connectorConfiguration>

	<schemaHandling>
		<objectType>
			<kind>account</kind>
			<intent>default</intent>
			<displayName>Koha Patron Account</displayName>
			<objectClass>tns:AccountObjectClass</objectClass>
			<default>true</default>

			<attribute>
				<ref>icfs:name</ref> <displayName>User ID (Login)</displayName>
				<outbound><source><path>$user/name</path></source></outbound>
				<inbound><target><path>$user/name</path></target></inbound>
			</attribute>
			<attribute>
				<ref>tns:surname</ref>
				<outbound><source><path>$user/familyName</path></source></outbound>
				<inbound><target><path>$user/familyName</path></target></inbound>
			</attribute>
			<attribute>
				<ref>tns:firstname</ref>
				<outbound><source><path>$user/givenName</path></source></outbound>
				<inbound><target><path>$user/givenName</path></target></inbound>
			</attribute>
			<attribute>
				<ref>tns:email</ref>
				<outbound><source><path>$user/emailAddress</path></source></outbound>
				<inbound><target><path>$user/emailAddress</path></target></inbound>
			</attribute>
			<attribute>
				<ref>tns:cardnumber</ref>
				<displayName>Card Number</displayName>
				<outbound><source><path>$user/employeeNumber</path></source></outbound>
				<inbound><target><path>$user/employeeNumber</path></target></inbound>
			</attribute>
			<attribute>
				<ref>tns:phone</ref>
				<outbound><source><path>$user/telephoneNumber</path></source></outbound>
				<inbound><target><path>$user/telephoneNumber</path></target></inbound>
			</attribute>
			<attribute>
				<ref>tns:library_id</ref>
				<displayName>Library ID (Branchcode)</displayName>
				<outbound><source><path>$user/extension/kohaBranchCode</path></source></outbound>
				<inbound><target><path>$user/extension/kohaBranchCode</path></target></inbound>
			</attribute>
			<attribute>
				<ref>tns:category_id</ref>
				<displayName>Koha Patron Category ID</displayName>
				<outbound><source><path>$user/extension/kohaCategoryId</path></source></outbound>
				<inbound><target><path>$user/extension/kohaCategoryId</path></target></inbound>
			</attribute>
			<attribute>
				<ref>tns:date_of_birth</ref>
				<outbound><source><path>$user/extension/dateOfBirth</path></source></outbound>
				<inbound><target><path>$user/extension/dateOfBirth</path></target></inbound>
			</attribute>
			<attribute>
				<ref>tns:expiry_date</ref>
				<outbound><source><path>$user/activation/validTo</path></source></outbound>
				<inbound><target><path>$user/activation/validTo</path></target></inbound>
			</attribute>
			<attribute>
				<ref>tns:restricted</ref>
				<outbound>
					<strength>strong</strength>
					<expression>
						<script>
							<code>$focus?.activation?.administrativeStatus == 'DISABLED' || $focus?.activation?.administrativeStatus == 'ARCHIVED'</code>
						</script>
					</expression>
				</outbound>
			</attribute>

			<attribute>
				<ref>tns:date_enrolled</ref>
				<inbound><target><path>$user/extension/dateEnrolled</path></target></inbound>
			</attribute>
			<attribute>
				<ref>tns:expired</ref>
				<inbound><target><path>$user/extension/isExpired</path></target></inbound>
			</attribute>
			<attribute>
				<ref>tns:updated_on</ref>
				<inbound><target><path>$user/extension/lastUpdatedOnResource</path></target></inbound>
			</attribute>

			<activation>
				<administrativeStatus>
					<outbound/>
					<inbound>
						<strength>weak</strength>
						<expression>
							<script>
								<code>shadow?.attributes?.restricted == true ? false : true</code>
							</script>
						</expression>
					</inbound>
				</administrativeStatus>
				<validityStatus>
					<inbound>
						<strength>weak</strength>
						<expression>
							<script>
								<code>
									import java.time.LocalDate;
									import java.time.format.DateTimeFormatter;
									expiryDateStr = shadow?.attributes?.expiry_date;
									if (expiryDateStr == null) return null;
									try {
										expiryDate = LocalDate.parse(expiryDateStr.toString(), DateTimeFormatter.ISO_LOCAL_DATE);
										return expiryDate.isBefore(LocalDate.now()) ? Validity.INVALID : Validity.VALID;
									} catch (java.time.format.DateTimeParseException e) {
										return null;
									}
								</code>
							</script>
						</expression>
					</inbound>
				</validityStatus>
			</activation>
		</objectType>

		<objectType>
			<kind>entitlement</kind>
			<intent>group</intent>
			<displayName>Koha Patron Category</displayName>
			<objectClass>tns:GroupObjectClass</objectClass>
			<default>true</default>

			<attribute>
				<ref>icfs:name</ref> <displayName>Category Description</displayName>
				<inbound><target><path>name</path></target></inbound>
			</attribute>
			<attribute>
				<ref>tns:category_type</ref>
				<inbound><target><path>extension/kohaCategoryType</path></target></inbound>
			</attribute>
			<attribute>
				<ref>tns:enrolment_period</ref>
				<inbound><target><path>extension/kohaEnrolmentPeriod</path></target></inbound>
			</attribute>
		</objectType>
	</schemaHandling>

	<capabilities>
		<configured>
			<cap:schema/>
			<cap:testConnection/>
			<cap:create/>
			<cap:read/>
			<cap:update/>
			<cap:delete/>
			<cap:activation/>
		</configured>
	</capabilities>

	<synchronization>
		<objectSynchronization>
			<name>Patron Synchronization</name>
			<objectClass>tns:AccountObjectClass</objectClass>
			<kind>account</kind>
			<intent>default</intent>
			<focusType>c:UserType</focusType>
			<enabled>true</enabled>
			<correlation>
				<q:equal>
					<q:path>c:name</q:path>
					<expression>
						<path>$account/attributes/icfs:name</path>
					</expression>
				</q:equal>
			</correlation>
			<reaction>
				<situation>linked</situation><synchronize>true</synchronize>
			</reaction>
			<reaction>
				<situation>deleted</situation><synchronize>true</synchronize>
				<action><handlerUri>http://midpoint.evolveum.com/xml/ns/public/model/action-3#unlinkAccount</handlerUri></action>
			</reaction>
			<reaction>
				<situation>unlinked</situation><synchronize>true</synchronize>
				<action><handlerUri>http://midpoint.evolveum.com/xml/ns/public/model/action-3#linkAccount</handlerUri></action>
			</reaction>
			<reaction>
				<situation>unmatched</situation><synchronize>true</synchronize>
				<action><handlerUri>http://midpoint.evolveum.com/xml/ns/public/model/action-3#addUser</handlerUri></action>
			</reaction>
		</objectSynchronization>

		<objectSynchronization>
			<name>Patron Category Synchronization</name>
			<objectClass>tns:GroupObjectClass</objectClass>
			<kind>entitlement</kind>
			<intent>group</intent>
			<focusType>c:RoleType</focusType>
			<enabled>true</enabled>
			<correlation>
				<q:equal>
					<q:path>c:name</q:path>
					<expression>
						<path>$shadow/attributes/icfs:name</path>
					</expression>
				</q:equal>
			</correlation>
			<reaction>
				<situation>linked</situation><synchronize>true</synchronize>
			</reaction>
			<reaction>
				<situation>deleted</situation><synchronize>true</synchronize>
				<action><handlerUri>http://midpoint.evolveum.com/xml/ns/public/model/action-3#deleteFocus</handlerUri></action>
			</reaction>
			<reaction>
				<situation>unlinked</situation><synchronize>true</synchronize>
				<action><handlerUri>http://midpoint.evolveum.com/xml/ns/public/model/action-3#link</handlerUri></action>
			</reaction>
			<reaction>
				<situation>unmatched</situation><synchronize>true</synchronize>
				<action><handlerUri>http://midpoint.evolveum.com/xml/ns/public/model/action-3#addFocus</handlerUri></action>
			</reaction>
		</objectSynchronization>
	</synchronization>

</resource>
